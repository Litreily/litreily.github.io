<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="simple life"><meta name="theme-color" content="#2d4356"><meta name="baidu-site-verification" content="pte8o83UGG"><title>RK3399 新设计工控机配置指南 | LITREILY</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.png"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script><script>var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?d55250b3059d32736607d30baa6e0ca2";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="LITREILY" type="application/atom+xml">
</head><link rel="stylesheet" type="text/css" href="/plugins/highlight/atom-one-dark.min.css"><script type="text/javascript" src="/plugins/highlight/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();
</script><script type="text/javascript" src="/js/ready.js" async></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><body class="night"><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/">LITREILY</a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/profile.jpg" width="128" height="128"></a><h1 class="ttl"><a href="/">LITREILY</a></h1></div><p class="m-desc">心之所向，无惧无悔,<br>愿求仁得仁，复无怨怼！</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/categories/">分类</a></li><li><span class="dot">●</span><a href="/tags/">标签</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><li><span class="dot">●</span><a href="/notes/">笔记</a></li><li><span class="dot">●</span><a href="/atom.xml">RSS</a></li><li class="m-sch"><form class="form" id="j-formsch" method="get"><input class="txt" type="text" id="local-search-input" name="q" value="搜索" onfocus="if(this.value=='搜索'){this.value='';}" onblur="if(this.value==''){this.value='搜索';}"><input type="text" style="display:none;"></form></li></ul><div id="local-search-result"></div></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">RK3399 新设计工控机配置指南</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2021/12/20/rk3399-dts/">2021-12-20</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/Embedded/">Embedded</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><p>用时两周，总算将新的 RK3399 工控机配置好了，期间遇到各种坑，在此记录一二。</p>
<h2 id="RK3399-工控机硬件配置"><a href="#RK3399-工控机硬件配置" class="headerlink" title="RK3399 工控机硬件配置"></a>RK3399 工控机硬件配置</h2><p>首先看下硬件配置。</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>数量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>TypeC</td>
<td>1个</td>
<td>OTG 口，可用于烧录固件</td>
</tr>
<tr>
<td>USB3.0</td>
<td>4个</td>
<td></td>
</tr>
<tr>
<td>USB2.0</td>
<td>2个</td>
<td></td>
</tr>
<tr>
<td>RTC芯片 hym8563</td>
<td>1个</td>
<td>用于RTC时钟存储</td>
</tr>
<tr>
<td>SD</td>
<td>1个</td>
<td>可插入SD/TF 卡</td>
</tr>
<tr>
<td>HDMI</td>
<td>1个</td>
<td>可接显示器</td>
</tr>
<tr>
<td>以太网口</td>
<td>2个</td>
<td>1个千兆，1个百兆</td>
</tr>
<tr>
<td>串口</td>
<td>3个</td>
<td>UART0, UART2, UART4, 其中UART2 作为console，波特率1500000</td>
</tr>
<tr>
<td>cp210x</td>
<td>1个</td>
<td>对应 /dev/ttyUSB0</td>
</tr>
<tr>
<td>pwm</td>
<td>1个</td>
<td>对应 pwm3</td>
</tr>
<tr>
<td>led</td>
<td>2个</td>
<td>电源指示灯，状态指示灯</td>
</tr>
<tr>
<td>按键</td>
<td>2个</td>
<td>1个复位按键，1个recover按键</td>
</tr>
<tr>
<td>DC-12 电源</td>
<td>1个</td>
<td>12V直流电源，rk808 电源芯片</td>
</tr>
</tbody></table>
<h2 id="kernel-启动失败"><a href="#kernel-启动失败" class="headerlink" title="kernel 启动失败"></a>kernel 启动失败</h2><p>首次编译SDK通过后，烧录固件至工控机，uboot正常执行，但是kernel执行3s左右停止。停止的位置固定，但是没有错误信息，感觉像是突然停止，停止前面是USB驱动加载信息，停止后不会自动重启。这个问题困扰我很久。</p>
<pre><code class="bash">[    1.963510] hub 4-0:1.0: USB hub found
[    1.964024] hub 4-0:1.0: 1 port detected
[    1.966154] dwmmc_rockchip fe310000.dwmmc: IDMAC supports 32-bit address mode.
[    1.966842] dwmmc_rockchip fe310000.dwmmc: Using internal DMA controller.
[    1.967451] dwmmc_rockchip fe310000.dwmmc: Version ID is 270a
[    1.968004] dwmmc_rockchip fe310000.dwmmc: DW MMC controller at irq 25,32 bit host data width,256 deep fifo
[    1.968898] dwmmc_rockchip fe310000.dwmmc: &#39;clock-freq-min-max&#39; property was deprecated.
[    1.969733] dwmmc_rockchip fe310000.dwmmc: No vmmc regulator found
[    1.970282] dwmmc_rockchip fe310000.dwmmc: No vqmmc regulator found
[    1.971302] dwmmc_rockchip fe310000.dwmmc: allocated mmc-pwrseq
[    1.985263] mmc_host mmc1: Bus speed (slot 0) = 400000Hz (slot req 400000Hz, actual 400000HZ div = 0)
[    1.999140] dwmmc_rockchip fe310000.dwmmc: 1 slots initialized
[    2.001576] dwmmc_rockchip fe320000.dwmmc: IDMAC supports 32-bit address mode.
[    2.002303] dwmmc_rockchip fe320000.dwmmc: Using internal DMA controller.
[    2.002958] dwmmc_rockchip fe320000.dwmmc: Version ID is 270a
[    2.003537] dwmmc_rockchip fe320000.dwmmc: DW MMC controller at irq 26,32 bit host data width,256 deep fifo
[    2.004488] dwmmc_rockchip fe320000.dwmmc: &#39;clock-freq-min-max&#39; property was deprecated.
[    2.005456] dwmmc_rockchip fe320000.dwmmc: No vmmc regulator found
[    2.006611] dwmmc_rockchip fe320000.dwmmc: allocated mmc-pwrseq
[    2.007435] rockchip-iodomain ff770000.syscon:io-domains: Setting to 3300000 done
[    2.008482] rockchip-iodomain ff770000.syscon:io-domains: Setting to 3300000 done
[    2.022019] mmc_host mmc2: Bus speed (slot 0) = 400000Hz (slot req 400000Hz, actual 400000HZ div = 0)
[    2.026205] mmc_host mmc1: Bus speed (slot 0) = 300000Hz (slot req 300000Hz, actual 300000HZ div = 0)
[    2.035890] dwmmc_rockchip fe320000.dwmmc: 1 slots initialized
[    2.040194] input: gpio-keys as /devices/platform/gpio-keys/input/input2
[    2.041572] ==gsl_ts_init==
[    2.041975] ret=0
[    2.043363] rk808-rtc rk808-rtc: setting system clock to 2013-01-19 05:34:15 UTC (1358573655)
[    2.066790] mmc_host mmc1: Bus speed (slot 0) = 200000Hz (slot req 200000Hz, actual 200000HZ div = 0)
[    2.078907] u?
[    2.111206] phy phy-ff770000.syscon:usb2-phy@e450.6: charger = USB_SDP_CHARGER
[    2.115781] rockchip-dwc3 usb0: USB peripheral connected
[    2.151998] usb 1-1.2: new full-speed USB device number 3 using ehci-platform
[    2.175032] usb 5-1: new high-speed USB device number 2 using xhci-hcd
</code></pre>
<p>由于是新设计的板子，所以无法确定是硬件问题还是软件问题，假定硬件没问题，那就是软件配置问题，于是我逐一排查DTS中gpio的配置，比对工控机原理图，发现 <code>SYR837</code> CPU 电源管理芯片的 gpio不匹配。原理图中配置如下：</p>
<p><img src="/assets/rk3399/syr837.png" alt="syr837"></p>
<p><code>CPU_B_SLEEP_H</code> 对应管脚如下：</p>
<p><img src="/assets/rk3399/syr837-gpio.png" alt="CPU_B_SLEEP_H"></p>
<p>这里是GPIO1_C1, 在dts中表示为 <code>GPIO1_17</code>, 实际dts中配置为 <code>GPIO1_18</code>, 所以不匹配，我将io修改后还是不行，怀疑是不是SPI功能复用所致，所以也确保SPI功能都<code>disabled</code>了，但是还是失败。</p>
<p>不过gpio修改后，发现log变了，kernel出现了 crash。log忘记保存了，根据crash信息，根据错误码排查到设备busy，说明有可能gpio被其它设备占用了，最后排查发现是 <code>vcc3v3_pcie</code> 节点也使用了 <code>GPIO1_17</code>, got you! 把这个disabled掉就正常了！而且这个pcie电源也没有被其它节点引用，所以禁用也不影响其它功能。</p>
<blockquote>
<p><strong>小结：</strong> kernel 启动失败的原因是cpu电源芯片的gpio配置错误，同时正确gpio还被<code>vcc3v3_pcie</code> 占用了，导致CPU供电异常，最后kernel停止运行。解决方案是修改<code>syr837</code> gpio配置，禁用 <code>vcc3v3_pcie</code></p>
</blockquote>
<pre><code class="patch">--- a/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
@@ -239,6 +239,7 @@
 
        vcc3v3_pcie: vcc3v3-pcie-regulator &#123;
                compatible = &quot;regulator-fixed&quot;;
+               status = &quot;disabled&quot;;
                enable-active-high;
                regulator-always-on;
                regulator-boot-on;
@@ -447,7 +448,7 @@                                                                                         
                regulator-min-microvolt = &lt;712500&gt;;
                regulator-max-microvolt = &lt;1500000&gt;;
                regulator-ramp-delay = &lt;1000&gt;;
-               vsel-gpios = &lt;&amp;gpio1 18 GPIO_ACTIVE_HIGH&gt;;
+               vsel-gpios = &lt;&amp;gpio1 17 GPIO_ACTIVE_HIGH&gt;;
                fcs,suspend-voltage-selector = &lt;1&gt;;
                regulator-always-on;
                regulator-boot-on;
@@ -945,7 +946,7 @@
 
 &amp;rockchip_suspend &#123;
        rockchip,power-ctrl =
-               &lt;&amp;gpio1 18 GPIO_ACTIVE_LOW&gt;,
+               &lt;&amp;gpio1 17 GPIO_ACTIVE_LOW&gt;,
                &lt;&amp;gpio1 14 GPIO_ACTIVE_HIGH&gt;;
 &#125;;
</code></pre>
<h2 id="USB-3-0-供电失败"><a href="#USB-3-0-供电失败" class="headerlink" title="USB 3.0 供电失败"></a>USB 3.0 供电失败</h2><p>kernel起来了，系统也跑起来了，接下来就是硬件接口配置了，首先测了测USB功能，使用串口设备插入USB接口，发现电源指示灯不亮，说明没有供电。根据原理图找到所有usb接口的电源使能管脚。</p>
<table>
<thead>
<tr>
<th>gpio</th>
<th>gpio1_num</th>
<th>io_num</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td><code>GPIO1_B1</code></td>
<td>gpio1_9</td>
<td>41</td>
<td><code>VCC5V0_USB3-1_EN</code></td>
</tr>
<tr>
<td><code>GPIO1_B2</code></td>
<td>gpio1_10</td>
<td>42</td>
<td><code>VCC5V0_USB3-2_EN</code></td>
</tr>
<tr>
<td><code>GPIO1_B5</code></td>
<td>gpio1_13</td>
<td>45</td>
<td><code>VCC5V0_USB3-3_EN</code></td>
</tr>
<tr>
<td><code>GPIO1_C2</code></td>
<td>gpio1_18</td>
<td>50</td>
<td><code>VCC5V0_USB3-4_EN</code></td>
</tr>
</tbody></table>
<p>然后通过 /sys/class/gpio 去使能。</p>
<pre><code class="bash">#!/bin/bash
cd /sys/class/gpio

# usb3.0-1~4: 41 42 45 50
gpios=(41 42 45 50)

for io in $&#123;gpios[@]&#125;
do
    echo $io &gt; export
    echo out &gt; gpio$io/direction
    echo 1 &gt; gpio$io/value
done
</code></pre>
<p>发现每次写入 1 后，读出来还是0，说明IO的输出不受控制，于是我测试了 <code>gpio1</code> 的其它io，部分可控，部分不可控。</p>
<p>为此，我使用 <code>io</code> 指令，结合 <code>RK3399</code> 寄存器手册，查看 gpio 的复用情况和寄存器配置情况是否正常。</p>
<h3 id="查询usb-gpio复用功能"><a href="#查询usb-gpio复用功能" class="headerlink" title="查询usb gpio复用功能"></a>查询usb gpio复用功能</h3><p>以 <code>gpio1_Bx</code> 接口为例，在 <code>TRM</code> 文档中搜索 <code>gpio1b</code>， 找到 io 复用寄存器地址。</p>
<p><img src="/assets/rk3399/pmugrf_gpio1b.png" alt="pmugrf_gpio1b"></p>
<p>这里有几个关键信息， <code>PMUGRF</code> 将用于查找基地址，offset <code>0x00014</code> 是 <code>PMUGRF_GPIO1B_IOMUX</code> 的偏移量。</p>
<p>那么如何查找基地址呢？其实文档的第一张图就是地址映射图 <code>Address Mapping</code>。从中可以找到 <code>PMUGRF</code>的基地址，当然也可以找到其它寄存器的基地址。</p>
<p><img src="/assets/rk3399/pmugrf.png" alt="pmugrf"></p>
<p>从图中知道基地址为 <code>0xFF320000</code>, 加上偏移量 <code>0x00014</code> 就等于 <code>0xFF320014</code>.</p>
<p>最后通过 <code>io</code> 指令去查询。</p>
<pre><code class="bash"># iomux
# PMUGRF Base: 0xff320000
# PMUGRF_GPIO1B_IOMUX offset: 0x00014

# read iomux
root@firefly:~# io -4 -r 0xff320014
ff320014:  00008141
</code></pre>
<p>查询结果是 <code>0x00008141</code>, 这个值该怎么读呢，这个是32位数据，对应gpio1_b0~gpio1_b7 共8个gpio的复用情况。每两个bit代表一个gpio。详情查看TRM文档中 <code>PMUGRF_GPIO1B_IOMUX</code> 寄存器说明。</p>
<p><img src="/assets/rk3399/gpio1b_iomux.png" alt="gpio1b_iomux"></p>
<p>对应 <code>0x00008141</code>, 可以解析出每个gpio的复用情况。</p>
<pre><code class="bash"># 0x8141:      10           00    00    01              01              00    00    01
# gpio1_B7~B0: i2c0pmu_scl, gpio, gpio, i2c4sensor_scl, i2c4sensor_sda, gpio, gpio, uart4m0_sout
#              B7           B6    B5    B4              B3              B2    B1    B0
</code></pre>
<p>最终查询到USB 3.0 <code>gpio1_b1</code>, <code>gpio1_b2</code> , <code>gpio1_b5</code> 均为 <code>GPIO</code> 模式，没有被复用，说明配置正常。</p>
<h3 id="查询USB-gpio-value"><a href="#查询USB-gpio-value" class="headerlink" title="查询USB gpio value"></a>查询USB gpio value</h3><p>既然复用寄存器没有问题，那再来看看 gpio value配置，看看使用 <code>sys/class/gpio/gpioxx/value</code> 配置有没有生效。</p>
<p>与查询复用情况类似，首先找到 <code>gpio1</code>的基地址。</p>
<p><img src="/assets/rk3399/gpio1_base.png" alt="gpio1_base"></p>
<p>基地址为 <code>0xFF730000</code>, 接着查看gpio 数据寄存器 <code>GPIO_SWPORTA_DR  </code> 的偏移量。</p>
<p><img src="/assets/rk3399/gpio_dr_offset.png" alt="gpio1_offset"></p>
<p><code>DR</code> 寄存器偏移量为 <code>0x0000</code>, 32位寄存器对应gpio1 32个gpio的数据。接下来使用 <code>io</code> 指令查询。</p>
<pre><code class="bash"># gpio1 base: 0xff730000
# DR offset: 0x00000000
# DDR offset: 0x00000004

# read DR
root@firefly:~# io -4 -r 0xff730000
ff730000:  00042602
# 0x42602: 0x0100 0010 0110 0000 0010
#               C0        B0        A0

# read DDR
root@firefly:~# io -4 -r 0xff730004
ff730004:  00062602
# 0x62602: 0x0110 0010 0110 0000 0010
#               C0        B0        A0

# 说明 gpio 的 direction, value 均配置正常
</code></pre>
<p>以上查询到 <code>DR</code> 和 <code>DDR</code> 的配置情况，均正常。</p>
<h3 id="USB-3-0-gpio-电源域配置"><a href="#USB-3-0-gpio-电源域配置" class="headerlink" title="USB 3.0 gpio 电源域配置"></a>USB 3.0 gpio 电源域配置</h3><p>到此为止，io配置、io查询、复用功能确认都正常，但是实际输出就是不对。最后只能在 <code>RK</code> redmine 系统中提交issues，根据他们提供的技术文档，发现io输出不受控的问题可能与电源域配置有关。</p>
<p>首先查看原理图，gpio1 的电源接口。</p>
<p><img src="/assets/rk3399/gpio1_power.png" alt="gpio1_power"></p>
<p>gpio1 使用 <code>PMUIO2</code> 电源，电压1.8v。然后查看 dts 中的配置。发现是 <code>3.0v</code>, 果然不一样！</p>
<pre><code class="bash">       uboot-set = &lt;RK3399_PMU1830_VDD_3V0&gt;;
       pmu1830-supply = &lt;&amp;vcc_3v0&gt;;
</code></pre>
<p>既然问题找到了，那解决方案就很明显了。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>修改 <code>pmu1830</code> 电源域配置。修改后，USB3.0 供电一切正常。</p>
<pre><code class="bash">--- a/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
@@ -866,8 +866,8 @@
         * also list here for more convenient configuration:
         * pmu1830-supply: RK3399_PMU1830_VDD_1V8 or RK3399_PMU1830_VDD_3V0
         */
-       uboot-set = &lt;RK3399_PMU1830_VDD_3V0&gt;;
-       pmu1830-supply = &lt;&amp;vcc_3v0&gt;;
+       uboot-set = &lt;RK3399_PMU1830_VDD_1V8&gt;;
+       pmu1830-supply = &lt;&amp;vcc_1v8&gt;;
 &#125;;

 &amp;pinctrl &#123;
</code></pre>
<h2 id="USB-2-0-无法识别串口设备"><a href="#USB-2-0-无法识别串口设备" class="headerlink" title="USB 2.0 无法识别串口设备"></a>USB 2.0 无法识别串口设备</h2><p><code>USB3.0</code> 问题是电源域的问题， <code>USB2.0</code> 则不太一样， <code>USB2.0</code> 供电正常，但是无法识别设备，而且不是所有接口都不能识别，两个接口，一个可以，一个不可以，但是它们共用一个usb hub，没道理会这样。最终由我老大发现是硬件问题，老大通过修改硬件电路解决了，perfect!</p>
<h2 id="TypeC-接口配置"><a href="#TypeC-接口配置" class="headerlink" title="TypeC 接口配置"></a>TypeC 接口配置</h2><p>DTS默认的typec的电源使能接口 <code>vbus-5v-gpios</code> 配置与原理图中是不匹配的，需要更正一下。</p>
<pre><code class="bash">--- a/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
@@ -739,7 +739,7 @@
                pinctrl-names = &quot;default&quot;;
                pinctrl-0 = &lt;&amp;fusb0_int&gt;;
                int-n-gpios = &lt;&amp;gpio1 2 GPIO_ACTIVE_HIGH&gt;;
-               vbus-5v-gpios = &lt;&amp;gpio2 0 GPIO_ACTIVE_HIGH&gt;;
+               vbus-5v-gpios = &lt;&amp;gpio1 3 GPIO_ACTIVE_HIGH&gt;;
                status = &quot;okay&quot;;
        &#125;;
</code></pre>
<h2 id="以太网配置"><a href="#以太网配置" class="headerlink" title="以太网配置"></a>以太网配置</h2><p>工控机包含两个以太网，默认千兆网没有打开，需要使能 <code>gmac</code>, 使能后，两个网口皆开，对应 eth0, eth1. 但是eth0 打开up失败。</p>
<pre><code class="bash">root@firefly:~# ifconfig eth0 up
[  128.132426] stmmac_open: Cannot attach to PHY (error: -19)
SIOCSIFFLAGS: No such device
</code></pre>
<p>最后排查是被其它设备占用io，禁用 <code>uart1</code>, <code>uart3</code> 后正常。</p>
<h3 id="brctl-失败"><a href="#brctl-失败" class="headerlink" title="brctl 失败"></a>brctl 失败</h3><p>由于包含两个网口，可能会用到网桥功能，我安装 <code>brctl</code> 后却发现无法使用, 提示参数错误。使用 <code>strace</code> 排查。</p>
<pre><code class="bash">root@firefly:~# brctl addbr br0
add bridge failed: Invalid argument
root@firefly:~# strace brctl addbr br0
execve(&quot;/sbin/brctl&quot;, [&quot;brctl&quot;, &quot;addbr&quot;, &quot;br0&quot;], [/* 18 vars */]) = 0
brk(0)                                  = 0x766000
uname(&#123;sys=&quot;Linux&quot;, node=&quot;firefly&quot;, ...&#125;) = 0
access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)
mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xf7237000
access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)
open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3
fstat64(3, &#123;st_mode=S_IFREG|0644, st_size=62149, ...&#125;) = 0
mmap2(NULL, 62149, PROT_READ, MAP_PRIVATE, 3, 0) = 0xf720a000
close(3)                                = 0
access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)
open(&quot;/lib/arm-linux-gnueabihf/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3
read(3, &quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0(\0\1\0\0\0\215w\1\0004\0\0\0&quot;..., 512) = 512
lseek(3, 908188, SEEK_SET)              = 908188
read(3, &quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;..., 2880) = 2880
lseek(3, 904740, SEEK_SET)              = 904740
read(3, &quot;A4\0\0\0aeabi\0\1*\0\0\0\0057-A\0\6\n\7A\10\1\t\2\n\3\f&quot;..., 53) = 53
fstat64(3, &#123;st_mode=S_IFREG|0755, st_size=911068, ...&#125;) = 0
mmap2(NULL, 947624, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xf7122000
mprotect(0xf71fd000, 28672, PROT_NONE)  = 0
mmap2(0xf7204000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0xda000) = 0xf7204000
mmap2(0xf7207000, 9640, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xf7207000
close(3)                                = 0
mmap2(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xf7236000
set_tls(0xf7236850, 0xf723a058, 0xf7236f38, 0xf7236850, 0xf723a058) = 0
mprotect(0xf7204000, 8192, PROT_READ)   = 0
mprotect(0x14000, 4096, PROT_READ)      = 0
mprotect(0xf7239000, 4096, PROT_READ)   = 0
munmap(0xf720a000, 62149)               = 0
socket(PF_LOCAL, SOCK_STREAM, 0)        = 3
ioctl(3, SIOCBRADDBR, 0xffb29954)       = -1 ENOPKG (Package not installed)
ioctl(3, SIOCSIFBR, 0xffb28848)         = -1 EINVAL (Invalid argument)
write(2, &quot;add bridge failed: Invalid argum&quot;..., 36add bridge failed: Invalid argument
) = 36
exit_group(1)                           = ?
+++ exited with 1 +++
root@firefly:~#
</code></pre>
<p>定位到 <code>ENOPKG</code> 错误，提示 <code>package not installed</code></p>
<pre><code class="bash">socket(PF_LOCAL, SOCK_STREAM, 0)        = 3
ioctl(3, SIOCBRADDBR, 0xffb29954)       = -1 ENOPKG (Package not installed)
ioctl(3, SIOCSIFBR, 0xffb28848)         = -1 EINVAL (Invalid argument)
</code></pre>
<p>搜索相关信息得知是内核配置不包含 <code>CONFIG_BRIDGE</code> 所致，添加该选项并重新编译内核后解决。 <code>brctl</code> 正常执行。</p>
<pre><code class="bash">brctl addbr br0
brctl addif br0 eth0
brctl addif br0 eth1
ifconfig br0 192.168.64.20 up
</code></pre>
<h2 id="添加-USB-wifi-支持"><a href="#添加-USB-wifi-支持" class="headerlink" title="添加 USB wifi 支持"></a>添加 USB wifi 支持</h2><p>由于工控机不自带wifi模块，可能会用到usb wifi网卡，所以需要添加驱动支持。</p>
<pre><code class="bash">--- a/arch/arm64/configs/rockchip_linux_defconfig
+++ b/arch/arm64/configs/rockchip_linux_defconfig
@@ -173,12 +173,13 @@ CONFIG_USB_NET_CDC_MBIM=y
 # CONFIG_USB_NET_ZAURUS is not set
 CONFIG_LIBERTAS_THINFIRM=y
 CONFIG_USB_NET_RNDIS_WLAN=y
+CONFIG_RTL8188EE=y
 CONFIG_RTL8192CU=y
 CONFIG_WL_ROCKCHIP=y
 CONFIG_WIFI_BUILD_MODULE=y
 CONFIG_WIFI_LOAD_DRIVER_WHEN_KERNEL_BOOTUP=y
 CONFIG_AP6XXX=y
-CONFIG_RTL8188EU=m
+CONFIG_RTL8188EU=y
 CONFIG_MWIFIEX=y
 CONFIG_MWIFIEX_SDIO=y
 CONFIG_LTE=y
</code></pre>
<h2 id="添加状态指示灯"><a href="#添加状态指示灯" class="headerlink" title="添加状态指示灯"></a>添加状态指示灯</h2><p>工控机包含两个led，其中一个电源指示灯，常亮，无需配置；另一个user led，需要修改dts支持。结合原理图找到对应管脚 <code>gpio4_c2</code>。</p>
<pre><code class="bash">--- a/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
@@ -152,6 +152,20 @@
                &#125;;
        &#125;;

+       leds &#123;
+               status = &quot;okay&quot;;
+               compatible = &quot;gpio-leds&quot;;
+
+               user &#123;
+                       label = &quot;led_ctl&quot;;
+                       linux,default-trigger = &quot;ir-user-click&quot;;
+                       gpios = &lt;&amp;gpio4 18 GPIO_ACTIVE_HIGH&gt;;
+                       pinctrl-names = &quot;default&quot;;
+                       pinctrl-0 = &lt;&amp;led_user&gt;;
+                       default-state = &quot;on&quot;;
+               &#125;;
+       &#125;;
+
        rt5640-sound &#123;
                compatible = &quot;simple-audio-card&quot;;
                simple-audio-card,format = &quot;i2s&quot;;
@@ -857,6 +871,12 @@
 &#125;;
                                                                                                            
 &amp;pinctrl &#123;
+       leds &#123;
+               led_user: led-user &#123;
+                       rockchip,pins = &lt;4 18 RK_FUNC_GPIO &amp;pcfg_pull_up&gt;;
+               &#125;;
+       &#125;;
+
        buttons &#123;
                pwrbtn: pwrbtn &#123;
                        rockchip,pins = &lt;0 5 RK_FUNC_GPIO &amp;pcfg_pull_up&gt;;
</code></pre>
<p>使能 <code>gpio-leds</code> 驱动后，可以通过 <code>/sys/class/leds/led_ctrl/brightness</code> 文件修改亮灯状态，为了让其闪烁，可以添加开机启动脚本。</p>
<pre><code class="bash">#!/bin/bash

ctl_file=/sys/class/leds/led_ctl/brightness
delay_sec=0.3

while true
do
  echo 1 &gt; $ctl_file
  sleep $delay_sec
  echo 0 &gt; $ctl_file
  sleep $delay_sec
done
</code></pre>
<h2 id="RTC-配置"><a href="#RTC-配置" class="headerlink" title="RTC 配置"></a>RTC 配置</h2><p>工控机外挂了 <code>hym8563</code> RTC芯片，需要外接一个纽扣电池，并在 <code>DTS</code> 添加支持。</p>
<pre><code class="bash">--- a/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3399-firefly-linux.dts
@@ -453,6 +453,16 @@
        i2c-scl-falling-time-ns = &lt;4&gt;;
        clock-frequency = &lt;400000&gt;;

+       hym8563: hym8563@51 &#123;
+               compatible = &quot;haoyu,hym8563&quot;;
+               reg = &lt;0x51&gt;;
+               #clock-cells = &lt;0&gt;;
+
+               clock-frequency = &lt;32768&gt;;
+               /* rtc_int is connected GPIO1_C6 */
+       &#125;;
+
        vdd_cpu_b: syr837@40 &#123;
                compatible = &quot;silergy,syr837&quot;;
                reg = &lt;0x40&gt;;
</code></pre>
<p>添加后无法正常使用，修改时间后无法保存，最终发现是硬件问题。</p>
<h2 id="PWM配置"><a href="#PWM配置" class="headerlink" title="PWM配置"></a>PWM配置</h2><p>根据原理图可知，工控机引出的 <code>pwm</code> 采用 <code>pwm3a</code> , 所以<code>dts</code> 中需要enable <code>pwm3</code>. 然后可以通过以下指令对 <code>pwm</code> 波进行配置。</p>
<pre><code class="bash">cd /sys/class/pwm/pwmchip1
echo 0 &gt; export
echo 50000 &gt; pwm0/period
echo 25000 &gt; pwm0/duty_cycle
echo 1 &gt; pwm0/enable
</code></pre>
<p>其中 <code>period</code> 代表 pwm 波的周期，单位 <code>ns</code>, <code>duty_cycle</code> 对应占空比，以上配置为 <code>50%</code>.</p>
<blockquote>
<p><strong>注意</strong>，这里用的是 <code>pwmchip1</code>, 而不是 <code>pwmchip0</code>, 因为 <code>pwmchip0</code> 对应 <code>pwm2</code>, 而 <code>pwm2</code> 被 <code>vdd_log</code> 引用，用于电源电压管理。</p>
</blockquote>
<h2 id="HDMI-无法显示"><a href="#HDMI-无法显示" class="headerlink" title="HDMI 无法显示"></a>HDMI 无法显示</h2><p>最后来看个大问题，<code>HDMI</code> 无法显示，首先确保<code>hdmi</code> ， <code>route_hdmi</code>, <code>display_subsystem</code> 等相关配置已经使能。使用 <code>Firefly</code> 固件编译是可以正常显示的，但是 <code>RK</code> 固件编译却不行。</p>
<p>一开始想着可能是io配置问题，但是禁用了其它外设后还是不行。不过既然 <code>Firefly</code> 的可以，那就可以对比了，为了确认是dts问题，还是内核驱动配置问题。我将 <code>Firefly</code> 的dts移植到 <code>RK</code> 固件，修改了部分选项后编译通过，而且 <code>HDMI</code> 正常显示了。这说明的确是 <code>DTS</code> 配置问题，与内核驱动配置无关。</p>
<p>接下来我将 <code>firefly</code> 的 <code>dts</code> 检查了一遍，禁用了其中的可疑选项后，<code>HDMI</code>又不能显示了，这说明我禁用的选项与 <code>HDMI</code> 显示有关，于是我将这个改动也添加到 <code>RK</code> 的 <code>dts</code>中。</p>
<pre><code class="bash">                        vcca1v8_codec: LDO_REG7 &#123;
                                regulator-always-on;
                                regulator-boot-on;
-                               regulator-min-microvolt = &lt;1800000&gt;;
-                               regulator-max-microvolt = &lt;1800000&gt;;
+                               regulator-min-microvolt = &lt;900000&gt;;
+                               regulator-max-microvolt = &lt;900000&gt;;
                                regulator-name = &quot;vcca1v8_codec&quot;;
                                regulator-state-mem &#123;
                                        regulator-off-in-suspend;
</code></pre>
<p>也就是 <code>rk808</code> 电源管理芯片中的 <code>vcca1v8_codec</code> 配置，将默认的 <code>1.8v</code> 改为 <code>0.9v</code>，至此，<code>hdmi</code> 正常显示。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>耗时两周左右的配置过程，让我遇到不少坑，以上总结的是其中的主要部分，还有很多小问题没有记录。总的来说，问题不少，但总算都解决了，也学到不少知识。</p>
<ol>
<li>假定软件问题的情况下，优先排查 <code>dts</code> 配置，再看驱动配置</li>
<li>新设计的板子，可以将 <code>gpio</code> 配置列表整理，方便查阅</li>
<li>在dts中添加新设备时，可以参考当前dts外其它设备的配置信息，或者参考 <code>Documents/devicetree/bindings/</code> 中的文档</li>
<li>在出现io输出不可控的时候，优先考虑io复用及电源域配置问题</li>
<li>通过查询寄存器手册，结合 <code>io</code> 指令可以查看或者修改寄存器配置</li>
<li>在确保软件配置无误情况下，如果仍旧异常，考虑硬件问题</li>
<li> <code>Firefly SDK</code> 编译后始终无法启动，但 <code>RK SDK</code> 中使用 <code>Firefly</code>的 <code>dts</code> 却可以正常启动，所以优先使用 <code>RK</code> 官方 <code>SDK</code></li>
</ol>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">本文作者：</span><span class="p-copytight-value"><a href="mailto:litreily@163.com">litreily</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2021/12/20/rk3399-dts/">https://www.litreily.top/2021/12/20/rk3399-dts/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">版权声明：</span><span class="p-copytight-value">本博客所有文章除特殊声明外，均采用<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>许可协议。转载请注明出处 <a href="https://www.litreily.top">litreily的博客</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tags"></i><a href="/tags/linux/">linux</a><a href="/tags/rk3399/">rk3399</a></span></div><aside id="toc"><div class="toc-title">目录</div><nav><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#RK3399-%E5%B7%A5%E6%8E%A7%E6%9C%BA%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">RK3399 工控机硬件配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kernel-%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5"><span class="toc-number">2.</span> <span class="toc-text">kernel 启动失败</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#USB-3-0-%E4%BE%9B%E7%94%B5%E5%A4%B1%E8%B4%A5"><span class="toc-number">3.</span> <span class="toc-text">USB 3.0 供电失败</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2usb-gpio%E5%A4%8D%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">3.1.</span> <span class="toc-text">查询usb gpio复用功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2USB-gpio-value"><span class="toc-number">3.2.</span> <span class="toc-text">查询USB gpio value</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#USB-3-0-gpio-%E7%94%B5%E6%BA%90%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">USB 3.0 gpio 电源域配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.4.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#USB-2-0-%E6%97%A0%E6%B3%95%E8%AF%86%E5%88%AB%E4%B8%B2%E5%8F%A3%E8%AE%BE%E5%A4%87"><span class="toc-number">4.</span> <span class="toc-text">USB 2.0 无法识别串口设备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TypeC-%E6%8E%A5%E5%8F%A3%E9%85%8D%E7%BD%AE"><span class="toc-number">5.</span> <span class="toc-text">TypeC 接口配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A5%E5%A4%AA%E7%BD%91%E9%85%8D%E7%BD%AE"><span class="toc-number">6.</span> <span class="toc-text">以太网配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#brctl-%E5%A4%B1%E8%B4%A5"><span class="toc-number">6.1.</span> <span class="toc-text">brctl 失败</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-USB-wifi-%E6%94%AF%E6%8C%81"><span class="toc-number">7.</span> <span class="toc-text">添加 USB wifi 支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%8A%B6%E6%80%81%E6%8C%87%E7%A4%BA%E7%81%AF"><span class="toc-number">8.</span> <span class="toc-text">添加状态指示灯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RTC-%E9%85%8D%E7%BD%AE"><span class="toc-number">9.</span> <span class="toc-text">RTC 配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWM%E9%85%8D%E7%BD%AE"><span class="toc-number">10.</span> <span class="toc-text">PWM配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HDMI-%E6%97%A0%E6%B3%95%E6%98%BE%E7%A4%BA"><span class="toc-number">11.</span> <span class="toc-text">HDMI 无法显示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">12.</span> <span class="toc-text">总结</span></a></li></ol></nav></aside></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2021/12/30/rk3288-su/">&lt; RK3288 android 6.0 user release 获取 root 权限</a><a class="next" href="/2021/10/27/system-app/">RK3288 android 6.0 内置系统应用 &gt;</a></div><div id="valine-comment"><style type="text/css">.night .v[data-class=v] a { color: #0F9FB4 !important; }
.night .v[data-class=v] a:hover { color: #216C73 !important; }
.night .v[data-class=v] li { list-style: inherit; }
.night .v[data-class=v] .vwrap { border: 1px solid #223441; border-radius: 0; }
.night .v[data-class=v] .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.night .v[data-class=v] .vbtn { border-radius: 0; background: none; }
.night .v[data-class=v] .vlist .vcard .vh { border-bottom-color: #293D4E; }
.night .v[data-class=v] .vwrap .vheader .vinput { border-bottom-color: #223441; }
.night .v[data-class=v] .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.night .v[data-class=v] code, .night .v[data-class=v] pre,.night .v[data-class=v] .vlist .vcard .vhead .vsys { background: #203240 !important; }
.night .v[data-class=v] code, .night .v[data-class=v] pre { color: #F0F0F0; font-size: 95%; }
.v[data-class=v] .vcards .vcard .vh {border-bottom-color: #223441; }
.night .v[data-class=v] .vcards .vcard .vcontent.expand:before {background: linear-gradient(180deg,rgba(38,57,73,.4),rgba(38,57,73,.9));}
.night .v[data-class=v] .vcards .vcard .vcontent.expand:after {background: rgba(38,57,73,.9)}
</style><div id="vcomment"></div><script src="//cdn.bootcdn.net/ajax/libs/valine/1.4.14/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'1ecKy4yk4u1R7C4tScKbnyq9-gzGzoHsz',
  appKey:'uvA3xgqNW3q8TGR483lxXcpB',
  lang: 'zh-cn',
  placeholder:'ヾﾉ≧∀≦)o Come on, say something...',
  avatar:'identicon',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2016 - 2021 <a href="/." rel="nofollow">LITREILY</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
    search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script></body></html>